<HEAD>
  <TITLE>WorkSpace / ScapeNode</TITLE>
  <meta charset="UTF-8"/>
</HEAD>
<BODY style="margin:0px;">
  <script>
  const bgf_color = (bg='white',f='black')=>`color:${f};background-color:${bg};`;
  const output_log = (target=null, style=bgf_color("#335","#DDE"))=>{
    if(typeof target==='object') target = JSON.stringify(target);
    console.log(`%c${target}`, style);
  };
  output_log(["aaa", "bbb", "ccc"]);
  const sleep = msec => new Promise(resolve => setTimeout(resolve, msec));
  const str_code = d=>(new Function("return" + d))();

  const protocpl = 'ws';
  const host = this.location.host;
  const page = 'repl';
  const url = `${protocpl}://${host}/${page}`;

  let server = null;
  let opened = false;
  let history = [];
  let history_size = 50;
  let ask = null;
  const updateServerLine = line=>{
    const dom = document.querySelector("#ServerLine");
    if(line){
      dom.classList.add("on");
      dom.innerText = 'ON-LINE';
    }else{
      dom.classList.remove("on");
      dom.innerText = 'OFFLINE';
    }
  }

  const command_log_flg = true;
  let commandLists = [];
  window.onload = function(){
    server = new WebSocket(url);
    ask = async q=>{
      if(!opened || !server) return null;
      server.send(q);
      if(command_log_flg) output_log(`$ ${q}`);
      return await new Promise((res,rej)=>{
        server.onmessage = function(e){
          m=e.data.split("\n"); m.pop(); m=m.join("\n");
          m=str_code(m); //prompt削除
          if(m!="" && typeof m!=='undefined'){
            history.push(m); history=history.slice(-history_size); //履歴保存と最大件数処理
            if(command_log_flg) output_log(m);
            res(history.slice(-1)[0]);
          }
        };
      });
    };
    server.onopen = async function(e){
      opened=true; console.log(`${url} connected!`); // 接続及びログ出力
      updateServerLine(true);
      await ask('await checkout("system");');
      await ask('await cd("workspace/commands");');
      await ask('await ls();');
    };
    server.onclose = async function(e){
      opened=false; console.log(`${url} disconnected!`);  // 切断及びログ出力
      updateServerLine(false);
    };
  };
  </script>

  <style>
  .modal{
    position: absolute;
    left: 0px;
    top: 0px;
    background-color: rgba(0,0,0,0.3);
    width: 100%;
    height: 100%;
    z-index: 9999;
  }
  #ServerLine{
    color: white;
    font-size: 16px;
    text-align: center;
    background-color: red;
    position: absolute;
    left: 0px;
    top: 0px;
    width: 75px;
    height: 25px;
  }
  #ServerLine.on{
    background-color: green;
  }
  #CommandPalette .window{
    position: relative;
    left: 50%;
    top: 10px;
    transform: translateX(-50%);
    background-color: #404550;
    max-width: 480px;
    min-width: 240px;
    height: 480px;
    border-radius: 5px;
    padding: 10px;
  }
  #CommandPalette .command{
    color: #EEE;
    caret-color: #DDE;
    background-color: #303440;
    border: none;
    width: 100%;
    margin-bottom: 10px;
    padding-left: 5px;
    font-size: 14px;
    height: 25px;
  }
  #CommandPalette .predict{
    background-color: #303440;
    height: calc(100% - 35px);
    border: solid 1px #303440;
    overflow-y: scroll;
  }
  #CommandPalette .predict .box{
    color: #CCD;
    background-color: #404550;
    border-bottom: solid 1px #303440;
    height: 30px;
    padding-left: 10px;
    line-height: 30px;
  }
  #CommandPalette .predict .box:last-child{ border-bottom: none; }
  #CommandPalette .predict .box:hover{ background-color: #505660; }
  </style>

  <div id="main">
    <div id="ServerLine">OFFLINE</div>

    <div id="CommandPalette" class="modal">
      <div class="window">
        <input type="text" class="command"/>
        <div class="predict">
          <div class="box">dummyA</div>
          <div class="box">dummyB</div>
          <div class="box">dummyC</div>

          <div class="box">dummy1</div>
          <div class="box">dummy2</div>
          <div class="box">dummy3</div>
          <div class="box">dummy4</div>
          <div class="box">dummy5</div>
          <div class="box">dummy6</div>
          <div class="box">dummy7</div>
          <div class="box">dummy8</div>
          <div class="box">dummy9</div>
          <div class="box">dummy10</div>
          <div class="box">dummy11</div>
          <div class="box">dummy12</div>
          <div class="box">dummy13</div>
          <div class="box">dummy14</div>
          <div class="box">dummy15</div>
        </div>
      </div>
    </div>
    <!--<div id="PathFinder" class="modal">
    </div>-->
  </div>
</BODY>
