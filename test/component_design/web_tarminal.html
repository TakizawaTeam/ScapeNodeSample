<style>
.tarminal{
  background-color: white;
  width: 100%;
  height: 200px;
}
.tarm-win{
  background-color: black;
  color: white;
  width: 100%;
  height: 100%;
  border: none;
  outline: 0;
}
.tarm-url{
  width:calc(80% - 17px);
  outline:0;
  height:17px;
  color:#888;
  border-size:1px;
}
.tarm-btn{
  width:20%;
  border:none;
  height:17px;
  padding:0px;
  outline:0;
  background-color: #FAA;
  cursor: pointer;
}
.tarm-btn.open{
  background-color: #AFA;
}
.tarm-menu{
  display: inline-block;
  vertical-align: top;
  width: 15px;
  height: 15px;
  background-color: #000;
  cursor: move;
  border: solid 1px #CCC;
  text-align: center;
  /*テキスト選択不可*/
  -moz-user-select: none;
  -webkit-user-select: none;
  -ms-user-select: none;
}
.ditail{overflow-y: scroll;}
</style>
<script>
_onload = function(e){
  const setTerminalUI = tarminal=>{ // set textarea
    const dom = tarminal.querySelector(".tarm-win");
    const header = tarminal.querySelector(".tarm-header");
    const KEY_CODE = {
      ENTER: 13,
      BACKSPACE: 8,
      LEFT: 37,
      UP: 38,
      RIGHT: 39,
      DOWN: 40,
    };
    const prefix = "$";
    const setCursor = v=>dom.setSelectionRange(v, v);
    const getCursor = ()=>dom.selectionStart;
    const getCommitCursor = ()=>parseInt(dom.dataset.commit_cursor);
    const setCommitCursor = n=>dom.dataset.commit_cursor=n;
    const setCancel = e=>e.preventDefault();
    const isBefore = (curr,diff=0)=>curr<getCommitCursor()+diff;
    const toBool = str=>str.toLowerCase() === 'true';
    const getInputFlg = ()=>toBool(dom.dataset.input_flag);
    const setInputFlg = f=>dom.dataset.input_flag=f;
    const dispatchCustomEvent = (dom, name, params)=>dom.dispatchEvent(new CustomEvent(name, {detail:params}));
    const setCommit = (str=null)=>{
      if(str) dom.value += str + "\n";
      setCommitCursor( getCursor()+1 );
      dom.value += prefix;
    };

    dom.dataset.commit_cursor = 0; //確定文字数
    dom.dataset.input_flag = "true"; //入力可能フラグ
    dom.addEventListener('keydown',function(e){
      const _input = e.keyCode;
      const _current = getCursor();

      if(!getInputFlg()) setCancel(e);
      if(_input==KEY_CODE["UP"] || _input==KEY_CODE["DOWN"]) setCancel(e);
      if((_input==KEY_CODE["BACKSPACE"] || _input==KEY_CODE["LEFT"]) && isBefore(_current-1)) setCancel(e);
      if(isBefore(_current-1,-1)) setCancel(e);
      if(_input==KEY_CODE["ENTER"]){
        const line_num = dom.value.lastIndexOf("$");
        const command = dom.value.slice(line_num+1, dom.value.length);
        dispatchCustomEvent(dom, "tarminal-commit", {command: command});
        if(dom.value.length!=getCursor()) setCursor(dom.value.length);
        setInputFlg(false);
      }
    });
    dom.addEventListener('keyup',function(e){
      const _input = e.keyCode;
      const _current = getCursor();
      if(!getInputFlg()) setCancel(e);

      if(_input==KEY_CODE["ENTER"] && dom.value.slice(-1)=="\n"){
        setCommit();
        setInputFlg(true);
      }
    });
    dom.addEventListener('tarminal-commit',function(e){
      console.log(e.detail.command);
    });
    header.querySelector(".tarm-btn").addEventListener('click',function(e){
      const _url = header.querySelector(".tarm-url").value;
      if(false){
        setCommit(`${_url} format error!`);
      }else{
        const server = new WebSocket(_url);
        setCommit(`${_url} connection...`);
        server.onopen = function(e){
          setCommit(`${_url} connected!`);
          header.querySelector(".tarm-btn").classList.add("open");
          setInputFlg(true);
        };
      }
    });

    (init=()=>{
      dom.value += prefix;
      setCommitCursor( getCursor() );
      setInputFlg(false);
    })();
  };

  const tarminal = document.querySelector(".tarminal");
  tarminal.querySelector(".tarm-url").value = "ws://localhost:2222/exec";
  setTerminalUI(tarminal);
};
window.onload = _onload;
</script>

<p class=".ditail">
1. Enterを押したら、確定カーソル位置を更新<br>
2. 確定カーソル位置以下なら入力キャンセル<br>
3. Backspaceやカーソル移動後、確定カーソル位置以下でも入力キャンセル<br>
</p>
<hr>

<div class="tarminal">
  <div class="tarm-header"><!--
    --><div class="tarm-menu">1</div><!--
    --><input type="text" class="tarm-url"/><!--
    --><input type="button" value="connect!" class="tarm-btn"/>
  </div>
  <textarea class="tarm-win"></textarea>
</div>

<hr>
<p class="ditail">
v1バグ：<br>
・コミットされた後に、prefixが追加されている<br>
・日本語入力で確定した際にも、コミットされてしまう<br>
・ドラッグやコピーができない<br>
v2バグ：<br>
・確定カーソル位置以下でも、日本語だと入力出来てしまう<br>
</p>
<p class="ditail">
追加仕様：<br>
1. URL欄のボタンを押して、ws:localhost:2222にリクエストして接続確立<br>
2. commitイベントでsendしてレスポンスを出力<br>
</p>
